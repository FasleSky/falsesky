<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Experiment 1 – Hand Magic Particles</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  background: #050505;
  font-family: 'Segoe UI', sans-serif;
}

canvas {
  position: fixed;
  top: 0;
  left: 0;
}

/* Popup */
#popup {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at top, #1a1a1a, #000);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.popup-box {
  background: linear-gradient(135deg, #111, #1f1f1f);
  padding: 40px 60px;
  border-radius: 20px;
  color: white;
  text-align: center;
  position: relative;
  box-shadow: 0 0 60px rgba(0,255,255,0.25);
  animation: pop 0.6s ease;
}

@keyframes pop {
  from { transform: scale(0.6); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

.popup-box h1 {
  font-weight: 500;
  font-size: 26px;
  background: linear-gradient(90deg, #ff7af5, #7afcff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

#closeBtn {
  position: absolute;
  right: 15px;
  top: 15px;
  background: transparent;
  border: none;
  color: white;
  font-size: 22px;
  cursor: pointer;
}

/* Camera video hidden */
video {
  display: none;
}
</style>
</head>

<body>

<!-- POPUP -->
<div id="popup">
  <div class="popup-box">
    <button id="closeBtn">✕</button>
    <h1>Show hand gesture to see magic</h1>
  </div>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/* ---------- BASIC SETUP ---------- */
const canvas = document.getElementById("canvas");
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);

const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x000000, 50, 300);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.z = 120;

/* ---------- PARTICLES ---------- */
const count = 12000;
let geometry = new THREE.BufferGeometry();
let positions = new Float32Array(count * 3);
let colors = new Float32Array(count * 3);

function generateShape(type) {
  for (let i = 0; i < count; i++) {
    let x=0,y=0,z=0;
    let t = Math.random() * Math.PI * 2;
    let r = Math.random() * 40;

    if (type === 0) { // Heart
      x = 16 * Math.pow(Math.sin(t),3);
      y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
      z = (Math.random()-0.5)*10;
    }
    else if (type === 1) { // Saturn
      x = Math.cos(t) * r;
      y = Math.sin(t) * r * 0.3;
      z = Math.sin(t) * r;
    }
    else if (type === 2) { // Infinity
      x = Math.sin(t) * 30;
      y = Math.sin(t*2) * 15;
      z = Math.cos(t) * 30;
    }
    else if (type === 3) { // Fireworks
      x = (Math.random()-0.5)*80;
      y = (Math.random()-0.5)*80;
      z = (Math.random()-0.5)*80;
    }
    else { // Spiral
      x = Math.cos(t) * r;
      y = t * 3 - 30;
      z = Math.sin(t) * r;
    }

    positions[i*3] = x;
    positions[i*3+1] = y;
    positions[i*3+2] = z;

    colors[i*3] = Math.random();
    colors[i*3+1] = Math.random();
    colors[i*3+2] = Math.random();
  }
}

generateShape(0);

geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));
geometry.setAttribute("color", new THREE.BufferAttribute(colors, 3));

const material = new THREE.PointsMaterial({
  size: 1.6,
  vertexColors: true,
  blending: THREE.AdditiveBlending
});

const particles = new THREE.Points(geometry, material);
scene.add(particles);

/* ---------- HAND TRACKING ---------- */
let handX = 0, handY = 0, spread = 1;
let shapeIndex = 0;

const hands = new Hands({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(results => {
  if (results.multiHandLandmarks?.length) {
    const lm = results.multiHandLandmarks[0];
    handX = (lm[9].x - 0.5) * 200;
    handY = (0.5 - lm[9].y) * 200;

    let d = Math.abs(lm[4].x - lm[8].x);
    spread = THREE.MathUtils.clamp(d * 6, 0.5, 4);

    if (d > 0.2) {
      shapeIndex = (shapeIndex + 1) % 5;
      generateShape(shapeIndex);
      geometry.attributes.position.needsUpdate = true;
    }
  }
});

/* ---------- CAMERA ---------- */
const video = document.getElementById("video");
const cam = new Camera(video, {
  onFrame: async () => await hands.send({ image: video }),
  width: 640,
  height: 480
});

/* ---------- ANIMATE ---------- */
function animate() {
  requestAnimationFrame(animate);

  particles.rotation.y += 0.002;
  particles.rotation.x += 0.001;

  particles.position.x += (handX - particles.position.x) * 0.05;
  particles.position.y += (handY - particles.position.y) * 0.05;

  material.size = spread * 1.6;

  renderer.render(scene, camera);
}

/* ---------- POPUP CONTROL ---------- */
document.getElementById("closeBtn").onclick = () => {
  document.getElementById("popup").style.display = "none";
  cam.start();
  animate();
};

window.addEventListener("resize", () => {
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>

</body>
</html>
